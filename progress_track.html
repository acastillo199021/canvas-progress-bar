function setupProgressTracking() {
  const allTabs = [...document.querySelectorAll('.dp-panel-heading')];
  const lectureTabs = allTabs.filter(tab =>
    tab.textContent.trim().toLowerCase().includes('lecture')
  );

  const iframe = document.querySelector('iframe[src*="progress_track.html"]');

  if (!lectureTabs.length || !iframe || !iframe.contentWindow) {
    console.log("⏳ Retrying progress tracker setup...");
    setTimeout(setupProgressTracking, 1000);
    return;
  }

  const clickedIndexes = new Set();

  // Clean bad commas in class names
  lectureTabs.forEach(tab => {
    tab.className = tab.className.replace(/,/g, '').replace(/\s+/g, ' ').trim();
  });

  // Add gray to all lecture tabs initially
  lectureTabs.forEach(tab => {
    tab.classList.add('tab-not-clicked');
  });

  // Mark Lecture 1 as clicked
  if (lectureTabs[0]) {
    clickedIndexes.add(0);
    lectureTabs[0].classList.remove('tab-not-clicked');
    lectureTabs[0].classList.add('tab-clicked');
  }

  lectureTabs.forEach((tab, index) => {
    tab.addEventListener('click', () => {
      if (!clickedIndexes.has(index)) {
        clickedIndexes.add(index);
        tab.classList.remove('tab-not-clicked');
        tab.classList.add('tab-clicked');
      }

      const sorted = Array.from(clickedIndexes).sort((a, b) => a - b);
      const lastClicked = sorted[sorted.length - 1];
      const skipped = [];

      for (let i = 0; i <= lastClicked; i++) {
        if (!clickedIndexes.has(i)) skipped.push(i);
      }

      const percent = Math.round((clickedIndexes.size / lectureTabs.length) * 100);

      iframe.contentWindow.postMessage({
        progress: percent,
        clickedCount: clickedIndexes.size,
        totalTabs: lectureTabs.length,
        skippedLessons: skipped,
        clickedIndexes: Array.from(clickedIndexes)
      }, '*');

      console.log(`✅ Progress sent: ${percent}% with ${clickedIndexes.size}/${lectureTabs.length} tabs clicked`);
      if (skipped.length) {
        console.warn(`⚠️ Skipped lessons: ${skipped.map(i => i + 1).join(', ')}`);
      }
    });
  });

  // Initial state push
  const initialPercent = Math.round((clickedIndexes.size / lectureTabs.length) * 100);
  iframe.contentWindow.postMessage({
    progress: initialPercent,
    clickedCount: clickedIndexes.size,
    totalTabs: lectureTabs.length,
    skippedLessons: [],
    clickedIndexes: Array.from(clickedIndexes)
  }, '*');

  console.log("✅ Progress tracking initialized");
}

// Handle dot clicks from iframe
window.addEventListener("message", (event) => {
  if (event.data && typeof event.data.scrollToTabIndex === "number") {
    const tabs = [...document.querySelectorAll('.dp-panel-heading')];
    const tab = tabs[event.data.scrollToTabIndex];
    if (tab) {
      tab.scrollIntoView({ behavior: "smooth", block: "center" });
      // 🛑 Do not mark as clicked here – only scroll
    }
  }
});

document.addEventListener('DOMContentLoaded', () => {
  setTimeout(setupProgressTracking, 1500);
});
